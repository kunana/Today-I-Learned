# TIL   / 2018 - 10 - 27
  ## Unity - Tips

>### 다중 모바일 디바이스 대응
 Google Console 에 보면 에러나는 기기들이 올라옴. 에러가 너무 많이 나면 해당 디바이스를 막는다. 해당 디바이스의 사용자가 많을때 오류가 난다면 평점이 내려가기에 막는게 현명한 방법 일수도 있다. 원하는 메모리나, 해상도등의 제약을 걸어서 자신이 만든 게임이 지원하는 디바이스만 다운 받도록 할수 있음

 디바이스를 빌려서 테스트가 정석. 그러나 한계점으로 같은 디바이스라도 문제가 발생하는 경우가 있음.
#### NScreen 대응법
스크린 마다 비율이 다른 문제는 정석적인 방법은 없으나,
예를 들어 갤럭시 3 의 해상도는 16 : 9. 그러나 갤럭시 9 나 아이폰 X 와 같은 메이져 하지 않은 해상도를 가진 디바이스에는 깨지기 마련.  

자신이 생각하는 메인디바이스의 해상도를 잡고, 해상도가 달라서 길어지거나 좁아질때, 위로 늘어나면 정해진 시점까지는 UI가 붙게 만들고 
가로로 늘어나면 옆을 막아버려서 원하는 해상도를 유지하게끔 만든다.

일본 회사 같은 경우는 해상도에 상관없이  위 아래를 미사용 공간 으로 막아버리고, 디바이스 화면 가운데만 사용함, 길어지면 길어질수록 미사용 공간을 늘여서 UI 등이 깨지지 않게 함
(개복치, 원피스 트레져 크루즈 등등)

유니티의 Screen Width , Height 에서 기준 점을 넘었을때 로직을 짜서 깨지지 않게 해야함.

 
NScreen 대응은 테스트를 많이 하는 수 밖에 없음

아이폰의 경우는 빠르면 18시간 늦으면 36시간 걸림. Crash 버그가 있는 게임은 출시를 못함. 그렇기에 스크린대응만 잘 맞춰주면 될듯.

>### 트러블 슈팅

1. 안드로이드 게임 터지는 부분은 Development Build, Auto Profiler 를 체크하고 개발자 빌드.에디터 프로파일러와 빌드 프로파일러와 다르기 때문에, 테스트.

2. 모바일 환경은 각자 다 사양이 달라서 무조건 Fixed Update 해야 차이가 안남

>### UGUI, NGUI?
+ 언제까지 유니티 업데이트에 대응될지 모름.
+ 퍼포먼스가 떨어지는 편이라, 내부원리 를 이해하지 않고 쓰면 최적화 하기도 힘들꺼라 생각.
###   UGUI 공부법
+ UI 기능은 유니티 레퍼런스를 보고 선 이해.
+ UI 적용은  유니티가 만든 게임 데모에서 자신이 만드는 게임과 비슷한 UI를 찾아서 뜯어보기.
### 캔버스 분리
+ 캔버스 분리를 잘해야함. 한 캔버스에 몰아서 넣으면, 하위에 있는 다른 UI도 다 렌더링을 다시함.
+ 변경 빈도가 높은 UI와 그렇지 않은 애들을 분리 해서 사용.
+ 케바케라서 캔버스 분리에 대해서는 프로파일러를 보고 판단하는게 좋을듯.
+ 기본적으로 보여주는 UI는 하나로 가되 느려지는 부분이 있다고 판단되면 프로파일링. 
> ### 파일 입출력
1. 저장하는 방식  - Text, CSV, XML, JSON, 등 원하는 대로.
2. 사용처 - 레벨디자인, 번역 텍스트 파일,
3. 유니티가 입출력을 하려면 반드시 Resources. 빌드할때 씬에 연결되어있으면 빌드 할때 같이 포함 되지만, 연결 안되어 있으면 반드시 __Resources.Load__
4. 에디터 상에서는 Application.Path 가 가능.
5.  __빌드할때는 Resources에 접근해야함.__
6.  AssetBundle은 서버로 붙어 받아서 하기 때문에 예외. AssetBundle 접근하는 방법은 찾아보기.
  
> ### 해킹 차단 방법
#### 막아야되는 게임 막지않아도 되는 게임 (모바일기준)
1. 유료게임(선결제)
2. 광고로 수익을 얻는 게임 (광고수익은 그다지 막을 필요가 없음)
3. 결제 유도 하는 게임
+ 1번의 경우. 크래킹 해서 무료로 뿌리는 경우 때문.
+ 3번의 경우. 예를 들어 헤비과금러가 리더보드 1위일때, 치트를 사용한 사람이 리더보드 1위가 되었음. 그럼 헤비과금러는 현타가 와서 환불을 요청할것임. 즉 다른 유저에게 영향을 주는 경쟁 기반의 게임. 유저가 시간과 노력, 현금을 써야하는 게임의 경우에는 반드시 막아야함.

#### 안티 해킹
1. 메모리 조작
+ 변수를 암호화 해서 저장 한다. 예를 들어서 그냥 int, double, float 등을 새로운 변수를 만들어서 암호화. 메모리를 찾지 못하게 한다. 자주 쓰이는 변수들은 암호화 강도를 낮춰서 빠르게, 그렇지 않으면 강도를 높여서 조작을 못하게.
<br>
2. APK를 분해해서 재조립하는 경우
+ AppSealing 서비스 -> 앱 역컴파일 보호 서비스. 유저수가 많아지면 유료화 됨. 가격이 싼 편이라서 이 서비스요금을 충당할 정도가 안되면 게임서비스를 포기해야함
+ 잘되면 엔프로텍트 

3. 유니티의 playerperf 조작
+ 플레이어 프리퍼런스는 키와 밸류 방식으로 저장하는데 저장할때는 암호화해서 저장. 복호화 해서 불러올때 위변조되있으면 데이터를 날려버리는 식. 캐치 받을때 싹 날리는 방식.
+ 데이터를 클라이언트에 저장하는 방식은 차선책이고, 보통은 클라에 데이터를 저장하면 안됨

4. 서버와 통신하는 데이터 해킹
+ 패킷 변조 일때는, 패킷에 담긴 데이터 순서를 가진 md5 변조를 탐지해서 변조 되었으면 난리.

5. 그래도 뜯으면 기기고유값을 블록. 


> ### 파티클
+ 3.x 부터 에서는 파티클이 좋지않았으나 4.x 부너는 Shuriken Particle 이 에셋 스토어에 올라옴. 이후 유니티 없데이트에서는 Shuriken particle을 기본으로 채택함.
+ 파티클의 기본 원리는 하나의 이미지를 대량으로 만들고 애니메이션을 줘서 움직임을 주는 것임. 
+ 파티클의 단점은 보통은 하나의 material 을 공유해서 쓰지만 Material을 따로 써야함.
+ ``부하를 줄이기 위해서 풀링을 해서 써야하고, 입자의 수나, 쉐이더의 종류를 따로 설정해서 쓰기.`` 

> ### 애니메이션
### 2D
#### Spine Animation
+ 캐릭터를 하나만 만들고, 각각의 부위를 잘라서 움직이게함.
##### 단점
관절인형이 움직이는 것 처럼 부자연 스럽고, 자연스럽게 할려면 노가다.
#### 장점
개발기간이 짧음.
리소스를 적게먹음

#### Sprite Animation
+ 캐릭터가 뛰는 모습을 여러개의 프레임으로 쪼개서 사용하는것.
##### 단점
 동작이 많아지면 그래픽 메모리가 많아지고, 리소스를 많이 차지함.
 개발기간이 오래걸림
##### 장점
 자연스러운 연출을 할수있음
### 3D

Maya, 3DMax, 를 제작.
#### 방식
Legacy - 애니메이션 툴에서 제작한 그대로만 사용가능. 수정불가
Generic -
Humanoid -본이 있으면 애니메이션 공유 사용 가능
+ 리깅할때 하나의 메쉬에 ``본의 갯수가 28 이상이면 퍼포먼스가 떨어지는 이슈``가 발생함.
#### 3d 애니메이션 무료 제작 -> [Mixamo]
[Mixamo]:(https://www.mixamo.com/)

> ### ``모바일 출시를 위한 필수 SDK 세팅``
현 추세는 웰메이드 게임. 운영, 통계 분석, 마케팅이 중요.
유니티 만으로는 불가능함.
#### 1. 게임센터(구글플레이 게임센터, 애플게임센터)
  >로그인, 데이터 백업, 리더보드, 업적
- 로그인 - 유저 식별을 위한 대안
- 데이터 백업 - 기기를 옮겨서 플레이하는 경우가 많음. 
- 간단한 데이터만 저장할때는 데이터 백업으로 사용해도 좋음
- 업적 -> 구글 플레이 계정 레벨을 올리고 싶어하는 사람 도 많음
#### 2. 인앱결제
1. 에셋스토어에서 다운로드, 
2. Unity Service 탭에서 이용
#### 3. 광고모듈 (``예전 세션에서 들은내용 추가할것``)
- 동영상 광고(AdMob, Unity AD, 등등..), 
- 전면광고, 배너 (AdMob 등),  오퍼월 광고, 
- 무과금러에 대해 게임을 더 오래, 쉽게 플레이 하기 위한 수단으로도 사용하는 경우가 있음.
- Unity DashBoard 에서 광고 수익에 대한 통계, 광고금회수 가능.
#### 3. 통계분석(``예전 세션에서 들은내용 추가할것``)
- 게임 레벨에서 각 레벨 마다로그를 걸어두고 어느 레벨에서 포기를 하는지 분석 가능.
- 통계를 통해 난이도 조절, 결제유도 등 지속적인 플레이를 시켜주기 위함

1. TapJoy, IGAWorks ADBricks, Flurry, FireBase(분석 + PushMSG)(무료) - 깊은 통계 불가
2. ADjust(유료) - 깊은 통계, PushMSG 보내기(보상 메세지. 대다수가 무조건 들어옴)
#### 4. SNS
- 로그인 기능, 친구초대, 스샷공유 기능 (신규유입가능)
#### 5. 네이버 플러그(한국 서비스일때)
- 네이버 카페 연결을 통한 피드백, 유저 간 공략 공유, 경쟁유도
- 연결을 하려면 네이버에서 심사를 받아야 사용 가능한 SDK 키를 줌.

> ### 서버에 대해서
#### 서버의 이유
1. 데이터 저장
- 유저 데이터 저장
- 비동기적인 대전을 동기적으로 보이게끔함. (각 유저의 데이터만 가져와서 대전 시켜주면 되니까)
- 육성게임은 데이터를 가지고 레벨별로 매칭을 시켜줘야함
- 대전을 했을때 온라인 되어있는 유저가 있으면 서로 매칭, 유저가 없으면 유저의 데이터만 가지고 대전 가능.

#### 데이터 저장 방식
1. 웹방식) 유니티 -> PHP, JSP -> MySql 
- 만들기 쉬움. 유저가 많이 지면 병목현상이 생기는데, 그에 대한 대비를 해주어야 함.
- 유저가 온라인이든 아니든 서버를 무조건 켜놓아야함
2. Lambda & DynamoDB) 유니티 -> Lambda(C, JAVA) -> DynamoDB
- 꺼져있다가 유저가 요청하면 켜지고, 안쓰면 꺼짐. 켜질때는 조금 느릴수 있으나 켜지고 나면 빠름.
- DB가 확장, 축소를 자동 적으로 해줌.
- 유니티와 람다 교신, 람다와 다이나모디비 와 교신 법을 배우면 됨
- 다이나모디비는 유니티에서 바로 데이터 송수신 저장 가능.
- 
> ### 최적화
- 엔진에 대한 이해도가 높아야 최적화를 함.
- 유니티는 기본 용량만을 20mb.
- 심플하고 리소스가 없이 레벨디자인만 보는 2d게임은 코코스가 괜찮다고 생각.
- 그래픽의 우선이라면 언리얼...

https://ijemin.com/blog/%EC%9C%A0%EB%8B%88%ED%8B%B0-2d-%EA%B2%8C%EC%9E%84-%EB%B9%8C%EB%93%9C-%EC%B5%9C%EC%A0%81%ED%99%94-%ED%8C%81/
2D모바일 게임빌드 최적화 팁.
프로파일러에서 열어서 4가지를 보자
프로파일러의 기능들에 대해 이해를 한다면 문제 해결 가능
FPS 60을 유지할수 있게끔
#### 코딩상의 문제
불필요한 재귀, Delegate, 불필요한 for문.
SendMsg 가 엄청느림. 
코딩상에 문제가 있으면 CPU 가 높게 잡힘 
60~ 100 사이로 오도록 낮춰야함. 60근처 ㄴㄴ 
#### 가비지의 문제
- 씬전환할때 가비지 컬렉터가 한번 잡힘
- 처음부터 가비지가 생기지 않게 코딩해야함. 가비지가 생기기 되었을때, 의도한 상황에서 가비지컬렉터를 돌려서 유저가 느끼지 못하게끔 해야함.
- 가비지컬렉터를 직접 호출시키는것은 쉬우나, 어느 시점에서 가비지가 쌓이고, 어느 시점에서 불러지는지 프로파일링 해야함
- 예를 들어 박싱, 언박싱에서 가비지가 많이 생김.
- http://www.gamecodi.com/board/zboard.php?id=GAMECODI_Talkdev&page=1&sn1=&divpage=1&sn=on&ss=on&sc=on&select_arrange=hit&desc=asc&no=4419
#### 구조(씬 로딩, 물리)의 문제
##### 물리 -> 퍼포먼스에 큰 영향을 줌
- 유니티 옵션값을 잘 설정해야할 문제
- 예를 들어 500명의 아군과 500명의 적이 섞여 있을때, 적만 공격하는 미사일이 날아올때, 그냥 만들면 아군, 적군의 콜라이더를 모든 검사를 함.
- 즉 콜라이더 검사를 할때 레이어를 분리해서 특정 콜라이더만 골라서 검사를 할수있게 해주어야 함
- Option - PhyshicManager 의 Layer Collision Matrix 설정.
- 충돌체가 지속적으로 겹쳐있을때의 예외 처리라던지
##### 구조
- 씬 로딩시 불필요한 오브젝트가 있다던지.
- 풀링할때 자신의 게임에 적합한 풀링인지. 
- 예를 들어 방치형 게임은 계속 켜놓음. 이중 이벤트성 씬에서는 풀링의 제한 시간을 두어야 함. 계속 되지 않게.
- 풀에서 꺼내올때 가장 리소스를 안먹고 원하는 오브젝트를 찾는 알고리즘
- 씬과 씬을 넘어갈때, 양쪽씬의 메모리가 동시에 적재됨
- 임시 씬을 만들어서 이전 씬의 메모리를 지워주고, 불러오도록. 
- http://egloos.zum.com/AnyRaiN/v/3778596 예제
- 

#### 렌더링의 문제
- 메인디바이스에서 원활하게 플레이 할때까지 직접 테스트를 하고 최적화 해야함.
- 드로우콜이 낮게 유지 되도록
#### 메모리의 문제
http://blog.goldface.kr/98
메모리 누수 문제를 잡아 보자.
- 텍스쳐, 오디오.
- 텍스쳐가 많이 차지하는데, 프로파일러를 체크해서 메인디바이스에서 목표로 하는 메모리를 체크. 
- 안쓰는 에셋들은 그자리에서 바로 해제를 해주어야함
- 오디오가 많이 차지하는 경우는 없음
- 큰 텍스쳐를 하나의 아틀라스로 묶으면 빠르게 되지만, 초기 로드가 오래걸림. (부가설명 http://rapapa.net/?p=2472)
- http://rapapa.net/?p=2694
- https://www.slideshare.net/ozlael/unite-seoul-2016-60714130
- 스프라이트 아틀라스 https://docs.unity3d.com/kr/2017.4/Manual/SpriteAtlas.html
> ### 인앱결제유도
> ### 협업 

포톤챗 채팅필터 안먹힘.. 비쌈
포톤챗 regeion. 같은 채널, 다른 regeion 이면 연결안됨

